
<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
    <script id="removeflag" type="text/javascript"></script>
    <meta charset="UTF-8">
    <title>验证码Demo</title>
</head>

<body>
<div id="verify">
</div>
<button onclick="test()">点击</button>
<script type="text/javascript">
    $(function () {
        test();
    });

    //回调函数：验证码页面关闭时回调
    function cbfn(retJson) {
        if (retJson.ret == 0) {
            // 用户验证成功
            $.ajax({
                url: "/graducation/verify/verifyCode",
                type: "POST",
                data: {"ticket":retJson.ticket},
                success: function (data) {
                    if(data == false){
                        window.location.href= '/graducation/demo.html';
                    }
                },
                error:function () {
                    window.location.href= '/graducation/demo.html';
                }
            })
        }
        else {
            //用户关闭验证码页面，没有验证
        }
    }
    function test() {
        $.ajax({
            url: '/graducation/verify/index',
            type: 'get',
            data:{'clientType':2},
            success: function (data) {
                var jsUrl = data.data;
                if(jsUrl != null && jsUrl.length !=0){
                    loadScript(jsUrl,init);
                    $("#verify").empty();
                    var form = $("<form id='myform' method='get'></form>");
                    form.attr("action","/graducation/verify/verifyCode");
                    var div = $("<div id='TCaptcha' style='width:310px;height:54px;'></div>");
                    form.append(div);
                    $("#verify").append(div);
                }
            }
        });
    }

    function loadScript(sScriptSrc, callbackfunction) {
        $("head #removeflag").nextAll().remove();
        //gets document head element
        var oHead = document.getElementsByTagName('head')[0];
        if (oHead) {
            //creates a new script tag
            var oScript = document.createElement('script');

            //adds src and type attribute to script tag
            oScript.setAttribute('src', sScriptSrc);
            oScript.setAttribute('type', 'text/javascript');

            //calling a function after the js is loaded (IE)
            var loadFunction = function () {
                if (this.readyState == 'complete' || this.readyState == 'loaded') {
                    callbackfunction();
                }
            };
            oScript.onreadystatechange = loadFunction;

            //calling a function after the js is loaded (Firefox)
            oScript.onload = callbackfunction;

            //append the script tag to document head element
            oHead.appendChild(oScript);
        }
    }

    function init(){
        var capOption = {callback: cbfn, showHeader: true, themeColor:"aaabbb"};
        capInit(document.getElementById("TCaptcha"), capOption);
    }
</script>
</body>
</html>